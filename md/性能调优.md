# 性能调优

> 性能调优听上去高大上，很多懂得性能调优的老司机喜欢把它当作宝贝，秘而不宣，但是我这人是不在乎的。
>
> 实际我们在写代码的时候，不经意间就曾做过这方面的工作，只是自己没有注意。当你改进了数据结构，降低了算法复杂度的时候；当你重构代码，去除了冗余的步骤的时候；当你把单线程工作改成多线程执行的时候......

当你通过USE方法定位到性能瓶颈的时候，就可以针对性能瓶颈做一定的优化。

所有的性能问题都是资源不够用的问题，解决思路一般就两种：一种是增加资源总量，另一种是减少每次使用的资源量。程序员一般能做的是后一种。

下面，我们针对几个常见的性能问题，给出性能优化思路。

## 情景1

有一天，客服MM跑过来告诉你，接到大量玩家投诉连不上游戏服务器，不能愉快地玩耍了。于是你根据USE方法，发现网络带宽使用率100%，意识到这是个很严重的问题。通过日志分析，发现都是正常的业务流量，排除了网络攻击的可能性。这个时候你应该怎么办呢？

- 增加I/O尺寸：例如，把带宽从200Mbps提高到2000Mbps，I/O时间可以降低到原来的1/10。这是一种经典的增加资源总量的思路。不过硬件成本也会随之上升，需要做一个硬件成本方面的考量

- 数据压缩：这是典型的减少每次使用资源的思路。如果要传输的数据可以压缩到原来的1/10，那么数据传输时间也只是原来的1/10，也许I/O便不是性能的瓶颈。不过数据压缩就意味着数据在使用时，还需要解压缩，性能开销从I/O转移到了CPU。所以这种优化方式，只适合I/O密集型的应用程序。
- 升级架构：有人说，我既没有钱升级硬件设备，又不能对通信数据进行压缩，因为我们的服务端的CPU占用也不低。那怎么办？那就只好升级你的I/O架构了，阻塞变非阻塞，单线程处理变多线程处理等等。

## 情景2

有一天，客服MM跑过来告诉你，接到大量玩家投诉连不上游戏服务器，不能愉快地玩耍了。然后你检查了一下服务器的进程发现，原来是个病毒程序（比如：门罗币挖矿的病毒）在疯狂占用CPU。于是你长输了一口气，绷紧的神经松弛了下来，这回终于可以甩锅了。:laughing:

## 情景3

有一天，客服MM跑过来告诉你，接到大量玩家投诉连不上游戏服务器，不能愉快地玩耍了。你查看了物理服务器环境，确实是游戏服务端的进程疯狂占用CPU资源。于是你根据USE方法，发现CPU使用率100%了，通过jstack日志定位到了问题，某个线程处于RUNNABLE状态。原来是自己的垃圾代码导致的，赶紧去修bug。

## 情景4

有一天，客服MM跑过来告诉你，接到大量玩家投诉连不上游戏服务器，不能愉快地玩耍了。你查看了物理服务器环境，确实是游戏服务端的进程疯狂占用CPU资源。于是你根据USE方法，发现这回是CPU使用率100%了。



> 增加缓存：当数据可以从高速缓存中读取，也可以解决I/O问题。不过，缓存的策略是一个值得研究的课题。

## 







**性能调优就是用更少的资源提供更好的服务，成本利益最大化。性能调优的手段并不新鲜，性能调优常规手段有：**

(1)  空间换时间，内存、缓存就是典型的空间换时间的例子。利用内存缓存从磁盘上取出的数据，CPU请求数据直接从内存中获取，从而获取比从磁盘读取数据更高的效率。

(2)   时间换空间，当空间成为瓶颈时，切分数据分批次处理，用更少的空间完成任务处理。上传大附件时经常用这种方式。

(3)   分而治之，把任务切分，分开执行，也方便并行执行来提高效率。

(4)   异步处理，业务链路上有任务时间消耗较长，可以拆分业务，减少阻塞影响。常见的异步处理机制有MQ（消息队列），目前在互联网应用中大量使用。

(5)   并行，多个进程或者线程同时处理业务，缩短业务处理时间，比如我们在银行办理业务时，如果排队人数较多时，银行会加开柜台。

(6)   离用户更近一点，比如CDN技术，把用户请求的静态资源放在离用户更近的地方。

(7)   一切可扩展，业务模块化、服务化（同时无状态化）、良好的水平扩展能力。

 

**分布式架构的运用给性能带来了革命性的提升，业务流程的调整也会显著提升系统性能，单系统的调优能够压榨出更高的处理能力。单机性能分析调优可从从以下四部分入手：**

(1)   性能分析方法

(2)   基于单机的性能分析与调优

(3)   基于业务流程优化的性能分析调优

(4)   基于结构（分布式、业务拆分）的性能分析与调优

 

**性能分析方法**

性能分析是一个大课题，不同的架构、不同的应用场景、不同的程序语言分析的方法若有差异，抽象一下大致分为两类。

(1)   自底向上：通过监控硬件及操作系统的指标（CPU、内存、磁盘、网络等硬件资源的性能指标）来分析性能问题（配置、程序等问题）。因为用户请求最终是由计算机硬件设备来完成的，做事的是CPU。

(2)   自顶向下：通过生成负载来观察被测试的系统性能，比如响应时间、吞吐量；然后从请求的起点由外及里一层一层的分析，从而找到性能问题所在。

不管是自上而下还是自下而上，关键点就是生成负载、监控性能指标。好一点的方式是先用自顶向下的方式解决掉明显的性能问题，再结合自底向上的方式分析更深层次的问题。